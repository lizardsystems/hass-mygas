# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [2.1.0] - 2026-02-22

### Added

 - Добавлены устройства услуг — для каждой услуги (газоснабжение, пеня, техобслуживание и др.) создается отдельное устройство, привязанное к аккаунту через `via_device`.
 - Сенсор баланса услуги — для каждого устройства услуги создается сенсор с балансом по данной услуге.
 - Сенсоры тарифных ставок — для услуг с тарифными ставками (children) создаются дополнительные сенсоры: стоимость по нормативу с атрибутами «Норматив потребления», «Цена за м³», «Дата начала».
 - Автоматическое удаление устаревших устройств услуг при обновлении данных.

## [2.0.0] - 2026-02-18

### Added

 - Добавлены устройства уровня аккаунта (ЛС) — создаются всегда, даже если нет счетчиков ([#14](https://github.com/lizardsystems/hass-mygas/issues/14), [#17](https://github.com/lizardsystems/hass-mygas/issues/17)).
 - Сенсоры аккаунта: баланс, номер лицевого счета, дата последнего обновления.
 - Кнопки аккаунта: обновление данных, запрос счета.
 - Устройства счетчиков привязаны к устройству аккаунта через `via_device`.
 - Добавлены сенсоры расчетного периода: начислено, оплачено, задолженность за период (включены по умолчанию), а также 14 дополнительных сенсоров (отключены по умолчанию): расчетный период, дата периода, сальдо на начало/конец, начисленный объем, оборот, списанная задолженность, плановая сумма, льготы, льготный объем, восстановленная задолженность, корректировки платежей, сальдо АПГП, авансовые начисления.
 - Устройства аккаунтов получили информативные имена: `ЛС {номер} ({алиас})`.
 - Добавлен Options Flow для настройки интервала обновления данных (1-168 часов, по умолчанию 24).
 - Добавлен модуль диагностики (`diagnostics.py`).
 - Добавлены переводы исключений (translated exceptions) в сервисах.
 - Добавлен файл `strings.json` для hassfest с секциями `options` и `exceptions`.
 - Добавлены шаги `reconfigure` и `reauth_confirm` в переводы.
 - Добавлены юнит-тесты (config flow, init, coordinator, устройства аккаунта, сенсоры расчетного периода).
 - Добавлен CI workflow для запуска тестов.

### Changed

 - Миграция на `runtime_data` вместо `hass.data[DOMAIN]`.
 - Декоратор `async_api_request_handler` разделён на `async_retry` (чистая логика повторов) и `async_api_request_handler` (маппинг исключений для координатора).
 - Валидация в config flow использует `async_retry` и общий метод `_async_try_validate`, убрана дублированная обработка ошибок.
 - Выделен общий базовый класс `MyGasCoordinatorEntity` для сущностей аккаунта и счетчика.
 - Извлечен хелпер `make_entity_unique_id()` для генерации unique_id сущностей.
 - Упрощена выгрузка интеграции (`async_unload_entry`).
 - Координатор использует внутренний `_LOGGER` и `config_entry=` в `super().__init__()`.
 - Упрощены entity description классы (убран Mixin, один класс).
 - Убраны hardcoded `name` и `icon` из entity descriptions (используются `translation_key` и `icons.json`).
 - Убрана ручная генерация `entity_id` (`async_generate_entity_id`).
 - `sw_version` в DeviceInfo заменён на `aiomygas.__version__`.
 - Переименовано `avabl_fn` → `available_fn` в entity descriptions.
 - Переименованы приватные хелперы `_to_str`, `_to_float`, `_to_int`, `_to_date` → `to_str`, `to_float`, `to_int`, `to_date`.
 - Добавлены аннотации `Final` к константам.
 - Удалены неиспользуемые константы, хелперы и исключения.
 - Сужен перехват исключений в `services.py`.
 - Улучшена типизация: добавлены аннотации типов в координатор и entity descriptions.
 - Рефакторинг `find_account_by_device_id()` — кэширование `get_counters()`, использование `enumerate()`.
 - Обновлён `manifest.json`: убраны `after_dependencies`, `integration_type`, пустые массивы.
 - Обновлена зависимость `aiomygas` до версии 2.4.
 - Обновлён `hassfest.yaml` на `actions/checkout@v4`.

### Fixed

 - Исправлена ошибка `date.today()` → `dt_util.now().date()` в `helpers.py` и `coordinator.py` (учёт часового пояса HA).
 - Исправлена мёртвая обработка исключений в `_async_update_data`: `MyGasAuthError` не достигал блока, т.к. уже конвертировался декоратором.
 - Исправлена ошибка `is list` вместо `isinstance()` при обработке ответа LSPU API.
 - Исправлена ошибка `NameError` при первом показе формы реавторизации.
 - Добавлена валидация учетных данных при реконфигурации.
 - Заменены `assert` на `HomeAssistantError` в координаторе (assert отключается в production).
 - Исправлена обработка ошибок аутентификации — `ConfigEntryAuthFailed` больше не перехватывается как `UpdateFailed`.
 - Исправлена опечатка `lspu_acount_id` → `lspu_account_id` в координаторе.
 - Убрано устаревшее предупреждение в логах для аккаунтов без счетчиков.
 - Диагностика: редактирование `phone` и `email` в данных координатора.

## [1.6.1] - 2025-11-23

### Fixed
 - Выводится предупреждение в лог если не найдены счетчики.

## [1.6] - 2025-11-22

### Fixed

 - Устаревший аргумент hass был убран из декоратора verify_domain_control.
 - Добавлена возможность реконфигурации интеграции без удаления и повторного добавления.
 - Обновлена возможность реавторизации интеграции при изменении учетных данных пользователя.
 - Улучшена типизация кода.
 - Добавлены yaml для автоматизации для нового Telegram bot (Home Assistant 2025.07).
 - Исправлены мелкие ошибки и улучшена стабильность интеграции.  
 - Обновлена документация.

## [1.5.1] - 2025-05-08

### Fixed

 - Для запроса счета за прошедший месяц нужно указывать первый день текущего месяца, иначе будет прислан нулевой счет.


## [1.5.0] - 2025-04-23

### Added

 - Поддержка получения счетов на указанную дату (месяц) и за прошлый месяц (по умолчанию).

### Updated

 - Исправлена документация
 - Добавлен пример запроса счета на указанную дату
 - Добавлен пример запроса счета за текущий месяц

## [1.4.1] - 2025-03-21

### Changed 

 - Изменена единица измерения на RUB/m³      


## [1.4.0] - 2025-01-08

### Updated 

  - С января 2025 года при запросе счета необходимо указывать первый день текущего месяца, а не предыдущего месяца (для которого требуется расчет).      


## [1.3.0] - 2024-12-11

### Added

- Добавлено уведомление о запросе счета на email

### Fixed 

 - При запросе счета на email через сервис get_bill возникала ошибка       

## [1.2.0] - 2024-03-29

### Added 

- Добавлен файл icons.json


## [1.0.0] - 2024-02-19

Первый публичный релиз.
